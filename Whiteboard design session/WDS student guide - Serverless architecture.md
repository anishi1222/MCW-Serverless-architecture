![Microsoft Cloud Workshops](https://github.com/Microsoft/MCW-Template-Cloud-Workshop/raw/main/Media/ms-cloud-workshop.png 'Microsoft Cloud Workshops')

<div class="MCWHeader1">
サーバーレス・アーキテクチャ
</div>

<div class="MCWHeader2">
ホワイトボード・デザインセッション ガイド（ワークショップ参加者向け）
</div>

<div class="MCWHeader3">
2021年11月
</div>

本書に記載されている情報は、URLやその他のインターネット上のウェブサイトを含め、予告なく変更されることがあります。特に断りのない限り、ここに記載されている会社、組織、製品、ドメイン名、電子メールアドレス、ロゴ、人物、場所、イベントの例は架空のものであり、実在の会社、組織、製品、ドメイン名、電子メールアドレス、ロゴ、人物、場所、イベントとの関連を意図したり推論したりするものではありません。適用されるすべての著作権法を遵守することは、ユーザーの責任です。著作権に基づく権利を制限することなく、マイクロソフトの書面による明示的な許可がない限り、本書のいかなる部分も、いかなる形式または手段 (電子的、機械的、複写、記録、その他) で、あるいはいかなる目的においても、複製、検索システムへの保存または導入、転送することを禁じます。

マイクロソフトは、本書の主題を対象とする特許、特許出願、商標、著作権、またはその他の知的財産権を有している場合があります。マイクロソフトの書面によるライセンス契約において明示的に規定されている場合を除き、本書の提供は、これらの特許、商標、著作権、またはその他の知的財産に対するいかなるライセンスもお客様に与えるものではありません。

メーカー名、製品名、URL は情報提供のみを目的としており、マイクロソフトは、これらのメーカーまたはマイクロソフトのテクノロジーによる製品の使用に関して、明示的、黙示的、法定的を問わず、いかなる表明および保証も行いません。メーカーや製品を掲載することは、マイクロソフトがそのメーカーや製品を推奨していることを意味するものではありません。また、第三者のサイトへのリンクが張られていることがあります。そのようなサイトはマイクロソフトの管理下にはなく、マイクロソフトは、リンク先のサイトのコンテンツ、リンク先のサイトに含まれるリンク、またはそのようなサイトの変更もしくは更新について、一切の責任を負いません。マイクロソフトは、リンク先サイトから受信するウェブキャスティングまたはその他の形式の伝送について責任を負いません。マイクロソフトは、これらのリンクをお客様の便宜のためにのみ提供しており、リンクを掲載することは、マイクロソフトが当該サイトまたはそこに含まれる製品を推奨していることを意味するものではありません。

© 2021 Microsoft Corporation. All rights reserved.

マイクロソフトと <https://www.microsoft.com/legal/intellectualproperty/Trademarks/Usage/General.aspx> に記載の商標は、マイクロソフトグループの商標です。その他の商標は各所有者に帰属します。

**Contents**

<!-- TOC -->

- [サーバーレス・アーキテクチャ ホワイトボード・デザインセッション ガイド](#サーバーレス・アーキテクチャ-ホワイトボード・デザインセッション-ガイド)
  - [要旨ならびに学習の目的](#要旨ならびに学習の目的)
  - [Step 1: ケーススタディのレビュー](#step-1-ケーススタディのレビュー)
    - [顧客の状況](#顧客の状況)
    - [顧客のニーズ](#顧客のニーズ)
    - [顧客からの反論](#顧客からの反論)
    - [よくあるシナリオの図示](#よくあるシナリオの図示)
  - [Step 2: PoCソリューションの設計](#step-2-PoCソリューションの設計)
  - [Step 3: ソリューションの提示](#step-3-ソリューションの提示)
  - [まとめ](#まとめ)
  - [参考情報](#参考情報)

<!-- /TOC -->
# サーバーレス・アーキテクチャ ホワイトボード・デザインセッション ガイド

## 要旨ならびに学習の目的

このホワイトボード・デザインセッションでは、Azureのサーバーレス・テクノロジーを使用して、データレイクにアップロードされる車両写真をほぼリアルタイムで処理するソリューションをグループで設計します。ナンバープレートデータを取り出し、エクスポート目的で高可用性NoSQLデータストアに格納する必要があります。データエクスポートのプロセスは、新しいナンバープレートデータをファイルストレージにエクスポートし、必要に応じて通知を送信することを調整するサーバーレスAzureコンポーネントがオーケストレーションします。また、Function Apps に新しい変更を自動的に発行するための Continuous Deployment (CD) プロセスを構成します。最後に、処理パイプライン全体を監視し、特に、処理需要に応じたコンポーネントのスケーリングに注意を払う必要があります。

このホワイトボード・デザインセッションが終了すると、サーバーレスアーキテクチャを活用する最善の方法について、より深い洞察を得ることができます。従来のホスト型 Web アプリケーションやサービスと比較して、わずかなコードと実質的にゼロのインフラで、拡張性とコスト効率に優れたソリューションを設計する方法をより深く理解することができます。

## Step 1: ケーススタディのレビュー

**Outcome**

顧客ニーズの分析　(約15分)

セッションの全参加者を集め、ファシリテーター/SMEがケーススタディの概要と技術的なヒントを紹介します。

1. チームメンバーやトレーナーとの顔合わせ

2. 学習者用ガイドのStep 1～3を読んでおく

3. チームで以下のケーススタディを検討する

### 顧客の状況

Contoso Ltd.は2011年にテキサス州ヒューストンで設立され、多くの顧客にカスタムソフトウェア開発ソリューションを提供しています。カスタムソフトウェア開発に加え、Eコマースから医療・金融サービスまで、いくつかの業界向けの請求・決済ソフトウェアスイートを開発しています。最近、新たな市場機会として有料道路のブース管理を追加し、ホームオフィスの近くで車両追跡と料金請求の処理を行うようになりました。この新しいビジネスベンチャーは、Contosoの課金サービスのポートフォリオに追加されたマイナーなものであったため、カスタムビルドの料金所ソフトウェアスイートの車両処理部分に大きなリソースを割いていません。このソフトウェア群の中で最も機能が豊富なのは、既存の支払い管理システムで、管理対象の料金所を通過後にドライバーに請求書を送るように拡張されています。請求書には、タイムスタンプ、料金所の場所、料金所を通過したときの車両の写真が含まれています。

Contosoは、わずかな数のローカル料金所を処理するTollBoothソフトウェアのためにわずかなリソースを割り当てていたため、ナンバープレートを識別し、そのデータを課金ソフトウェアに送信するために手動プロセスを使用していました。車両が料金所を通過する際、中解像度の画像を撮影してナンバープレート番号と文字を特定し、Contosoは最終的にそれを使って顧客を調べ、請求書を作成します。Contosoは、この画像を定期的にパッケージ化してサードパーティベンダーに送り、ベンダーが手作業でナンバープレートを特定し、そのリストをContosoに送り返します。この時点で、Contosoは1,000件のトランザクションを一括して収集し、FTPサーバーでホストされているCSVファイルに情報を保存し、下流の会計システムがナンバープレート情報を抽出し、顧客に請求書を発行しています。

Contosoは最近、テキサス州全域の料金所を管理するという予想外の大型契約を獲得し、その結果、カバー率が2500%にまで広がりました。さらに、オクラホマ州、ニューメキシコ州でも料金所サービスを提供する方向で交渉中です。このような急成長によるメリットは明らかですが、同社はそれに伴う需要に応えられないことを懸念しています。同社の課金ソフトウェアは当初から開発の中心であり、他の市場にも進出し、大規模なトランザクションやデータ処理に対応できることを証明してきました。しかし、Contoso社は、TollBoothインフラのナンバープレート処理部分をどれだけ迅速に自動化できるか、また、自動化されたソリューションが需要に応じて拡張できるか、特に予期せぬトラフィック急増時に対応できるかを懸念しています。

Contoso Ltd.のCIOであるAbby Burrisはこのように言っています。

__「私たちが必要としているのは、アップロードされた車両の写真を素早く取り込み、ナンバープレートをインテリジェントに検出する軽量で強力な方法です。最も重要なことは、長期間のアプリケーションインスタンスを管理したくないということです。また、開発者がトレーニングを受けることなく、既存のインフラに迅速に統合できるものが必要です。私たちの第一の目標は、この手動処理パイプラインを迅速に置き換える一方で、課金プラットフォームのコアサービスに開発リソースを割き続けることです。」__

Abbyは、比較的新しいサーバーレス・コンピューティングの動きを追っており、サーバーレス・アーキテクチャの利点は、このプロジェクトで実現したいことにマッチしていると考えているようです。すでに最大限の能力を発揮しているITチームにとって、インフラのお守りの責任は少ないほど良いのです。しかし、従来のWebアプリケーションのように、サーバーレスコンポーネントをローカルで開発し、CI/CD DevOpsの手法でデプロイプロセスを自動化することが可能かどうかはわかっていないようです。

Contoso には機械学習の専門家やデータサイエンティストがいないため、既製の機械学習サービスを使用して画像上でナンバープレート認識タスクを実行する選択肢について、よりよく理解したいと考えています。高度な機械学習モデルを適切に作成・訓練するようスタッフに教え、この単一タスクのために機械学習サービスのホスティングコストを負担するよりも、この方法を希望しているのです。

Contosoは、撮影した車両の写真をクラウドストレージに保存し、カスタムのウェブアプリケーションやモバイルアプリケーションから検索できるようにしたいと考えています。これらの写真は、顧客の請求書に記載するために、下流の課金サービスからアクセスできる必要があります。機械学習サービスで自動検出できないナンバープレートを含む画像は、そのようにマークしておき、後でアクセスして手動で確認する必要があります。同様に、写真のナンバープレート検出が成功すると、ナンバープレート情報を撮影日時、料金所IDとともにデータベースに保存する必要があります。Contosoにはカスタマーサービス部門があり、手動検証用にマークされた写真のキューを監視し、ナンバープレートをウェブベースのフォームに入力して、自動処理されたナンバープレートデータと一緒にエクスポートすることができます。

ナンバープレートデータをエクスポートするプロセスも自動化する必要があります。Contosoは、前回のエクスポート以後に受信した新しいナンバープレートデータを抽出し、課金ソフトウェアに取り込まれるCSVファイルに保存するために、スケジュールされた間隔で実行される自動ワークフローを希望しています。彼らはすでにCSV取り込みプロセスを自動化しているため、ファイルを保存する以上の変更は必要ありません。FTPサーバーは、ローカルファイルシステムではなく、クラウドストレージコンテナを指すように変更する必要がありますが、これは自動化タスクの範囲外の簡単な処理です。エクスポート間隔は1時間に設定する必要がありますが、必要に応じて期間を延長したり短縮したりできるようにします。この時間間隔は、課金システムで使用される自動ファイル取り込みプロセスに基づいています。

カスタマー・サービスは、データがないために自動エクスポートが完了しない場合、特定の監視用アドレスに警告メールを送信するよう要請しています。エクスポートの間隔と、1時間に料金所を通過する車の平均台数を考えると、エクスポートするデータがないのは例外的なことで、ルールではありません。このアラートによって、不要なアラート通知に煩わされることなく、社内のサポートチャネルを通じてライセンス処理パイプラインを調査し、問題があれば迅速に対処できるという安心感を得ることができるでしょう。メールサービスにはOffice 365を利用しています。

電子メールによるアラート通知に加えて、Contoso社は、自動化されたプロセスをリアルタイムで監視し、必要に応じて過去のテレメトリのドリルダウンのための集中監視ダッシュボードを持つことを希望しています。このダッシュボードは、Azureのさまざまなコンポーネントを監視し、ソリューション全体のボトルネックや弱点がないかを確認するために役立ちます。また、監視ダッシュボードには、何か問題が発生した場合にITスタッフに通知するためのカスタムアラートを追加できるようにする必要があります。

Burris氏は以下のように述べています。
__「当社の役員は、サーバーレスアーキテクチャの概念を取り入れ、本当に長期的なパフォーマンスとコストのメリットがあるかどうかを確認したいと考えています。有料道路料金所の契約という予期せぬ利益を得たことで、将来的にITと開発チームが再び不可能を可能にするよう求められたときに、頼れるテスト済みの戦略があることを確認したいのです」__

Contoso社は、ストレッチゴールとして、彼らが実装した免許証処理パイプラインが、ナンバープレートの処理に成功した時点で可能となる将来のシナリオに拡張可能であることを知りたいと考えています。彼らが考えているシナリオの1つは、パイプラインがより高度な分析をサポートする方法です。Contosoは、ストリーミングでデータを処理し、バッチで過去のナンバープレート捕捉イベントを処理する機能を求めています（例えば、10テラバイト単位の過去のデータを分析できるようなスケーラビリティを持つもの）。これらの分析シナリオを、サーバーレスアーキテクチャを使用して実装できるかどうかに興味があります。

### 顧客のニーズ

1. 手作業のプロセスをサーバーレスコンポーネントを使う信頼性のある自動化ソリューションに置き換えたい

2. 正確にナンバープレートを読み取る、AIの訓練が不要な機械学習サービスを使いたい

3. 自動化システムで処理に失敗した画像に対して、手作業でナンバープレートデータを入力できるようにしたい

4. 画像処理に予期せぬスパイクが発生するような予測できない交通状況にも耐えるよう、すべての料金所を通過する無数の車にスケール可能なソリューションであってほしい

5. 定期的に処理済みライセンスプレートデータをエクスポートする自動化ワークフローを確立し、エクスポートデータがゼロ件の場合にアラートを発行できるようにしたい

6. サーバーレスコンポーネントをローカルで開発し、ソース管理システムからの自動化されたデプロイメントパイプラインを確立したい

7. サーバーレスコンポーネントやより深い分析のための履歴テレメトリデータのリアルタイムビューを提供し、カスタムアラートをサポートする監視ダッシュボードを使いたい

8. サーバーレスバッチ分析やリアルタイム分析、将来はその他のシナリオもサポートする、拡張性のあるソリューションを設計したい

### 顧客からの懸念・異論・反論

1. 個々のサーバーレスコンポーネントがどのように互いに「会話」し、パイプラインを通じて確実にメッセージを受け渡すことができるかを懸念しています。

2. 無限に拡張できるサーバーレスアーキテクチャは、私たちに毎月の多額の請求のリスクをもたらすのでしょうか？

3. 誤った画像処理によって、特定の有料道路の請求書が漏れてしまったり、最悪の場合、間違った相手に請求書を送ってしまったりしないようにするには、どうすればよいでしょうか？

4. 請求書に関する情報や車両を撮影した写真を取得できるお客様用APIの作成を検討していますが、不正なアクセスや過剰なリクエストによるサービス拒否攻撃の可能性が懸念されます。不正アクセスや過剰なリクエストからAPIを守る、監視や管理もできるセキュアなAPIを実装できるAzureのサービスはないでしょうか。

5. 接続文字列などのアプリケーションの機密情報を、ポータルで権限のないユーザーに見られないようにするには、どのような方法がありますか？

6. Azure FunctionsとLogic Appsの間に機能的な重複があるように見えます。それぞれをどのような用途で使用すればよいのでしょうか。

7. サーバーレスアーキテクチャについて調べていると、コールドスタートによるレイテンシーの増加の可能性があることがわかりました。これはAzure Functionsで問題になりますか。

### よくあるシナリオの図示

![The Common Scenario diagram begins with an Internet icon on the left. Arrows point from this icon to an Azure Data Lake Storage (ADLS) Gen2 icon and an Azure API Management icon. The ADLS Gen2 icon points to an Azure Functions icon, which points to a second Azure Functions icon (via an Event Grid arrow) and a second ADLS Gen2 icon. This ADLS Gen2 icon then points and ends at a Logic Apps icon. The Azure API Management icon points to two separate Azure Functions icons, which point to an Azure Cosmos DB icon. The Azure Cosmos DB icon then points to and ends at a Power BI icon.](media/common-scenarios.png 'Common Scenario diagram')

## Step 2: PoCソリューションの設計

**Outcome**

ソリューションを設計し、15分間のチョークトーク形式でターゲットとなる顧客層に発表するための準備をしてください (60分)。

**Business needs**

Directions: チームで、以下の質問に答え、自分の解決策を他の人に発表する準備をしてください。

1. このソリューションを誰に紹介しますか？対象となる顧客は誰ですか？意思決定者は誰ですか？

2. そのソリューションで解決すべき顧客のビジネスニーズは何か？

**Design**

Directions: チームで、以下の質問に答えてください。

_ハイレベルアーキテクチャ_

1. 詳細には触れませんが（次のセクションで説明します）、ナンバープレート処理のサーバーレスコンポーネント、OCR機能、データエクスポートワークフロー、監視とDevOpsに関するトップレベルの要件を処理するための最初のビジョンを図にします。

_ナンバープレート・サーバーレスコンポーネント_

1. サーバーレスコンポーネント間のイベント駆動型アクティビティをオーケストレーションするために、どのAzureメッセージングサービスの使用を推奨しますか？

2. イベントトリガー時にカスタムビジネスロジックコードを実行するために、Contosoが使用することを推奨するAzureサービスは何ですか？

3. 実行された作業に対してのみ課金し、需要に対応するために自動的に拡張するサービスで、どの価格体系 (Pricing Tier) を推奨しますか？

4. サーバーレスコンポーネントが動的に拡張することで高負荷になる場合があります。その際、機械学習API、データベース、ファイルストアなどの下流コンポーネントが過負荷にならないようにするには、どうすればよいでしょうか。

5. ナンバープレートデータの保存には、どのようなAzureサービスを推奨しますか？需要に応じて自動的にスケールし、他のサーバーレスコンポーネントとのバインディングを提供し、データストアへの接続とデータ保存を簡素化するオプションを検討してください。

_ナンバープレートOCR_

1. Contosoがオブジェクト文字認識 (OCR) 処理を行い、システムに入る各写真からナンバープレートを抽出するために、どのようなサービスを使用することを推奨しますか？

2. OCRサービスをナンバープレート処理フローにどのように統合しますか？

_Data export workflow_

1. 処理されたナンバープレートデータをエクスポートし、必要に応じてアラートを送信するために、定期的に実行される自動ワークフローを作成するには、どのAzureサービスをお勧めしますか？

2. あなたのワークフローに統合する他のサービスはどれですか？

_拡張可能なサーバーレス分析_

1. 画像からナンバープレートを正常に抽出したときのイベントに応答する、より多くのソリューションをプラグインできるようにしたいと考えています。その場合、Event Gridを使用してどのようにソリューションを拡張しますか？システムトピック、カスタムトピック、サブスクリプションを具体的に検討してください。

2. サーバーレスソリューションとしてリアルタイムおよびバッチ分析を提供するために利用可能な、ナンバープレートイベントをリッスンするEvent Gridサブスクリプションにプラグインするパイプラインは何でしょうか？

_監視とDevOps_

1. Contosoがサーバレスコンポーネントをローカルで開発し、ソースコードリポジトリと同期し、継続的なデプロイメントを実装するために、どのようなツールやサービスを使用するように勧めますか？

2. 実行中のすべてのサーバーレスコンポーネントを、単一のダッシュボードからリアルタイムで監視するには、どうすればよいでしょうか？

3. モニタリングソリューションは、過去のテレメトリデータの探索とアラートの設定をサポートしていますか？

**Prepare**

Directions: チームとして以下のことができるようにしてください:

1. 提案されたソリューションで対応できない顧客ニーズを特定する。

2. 提案するソリューションの利点を挙げる。

3. 顧客からの反対意見への対応を決める。

15 分間のチョークトークのスタイルで、顧客にプレゼンテーションしてください。

## Step 3: ソリューションの提示

**Outcome**

15 分間のチョークトーク形式で、顧客に対して解決策を提示してください (30分) 。

**Presentation**

Directions:

1. 他のチームとペアを組んでください。

2. 一方のグループがマイクロソフトのチーム、もう一方が顧客のチームとします。

3. マイクロソフトチームが顧客チームに対し解決策を提示します。

4. 顧客チームは前述の異議リストの中から1つ異議を申し立ててください。

5. マイクロソフトチームはその反対意見に対応してください。

6. 顧客チームはマイクロソフトチームにフィードバックをしてください。

7. 役回りを入れ替えて、2～6を繰り返しましょう。

## まとめ

ブレイクアウト前のグループに戻って、ファシリテーター/SMEがケーススタディの好ましい解決策について発表するのを聞いてください (15分) 。

## 参考情報

|                 |           |
| --------------- | --------- |
| **Description** | **Links** |
| Azure Functions の概要                     | <https://docs.microsoft.com/azure/azure-functions/functions-overview> |
| Azure Logic Apps とは                           | <https://docs.microsoft.com/azure/logic-apps/logic-apps-overview> |
| Azure Cosmos DB の概要                              | <https://docs.microsoft.com/azure/cosmos-db/introduction> |
| Azure メッセージング サービスの中から選択する - Azure Event Grid、Event Hubs、および Service Bus | <https://docs.microsoft.com/azure/event-grid/compare-messaging-services> |
| Azure Functions を監視する  | <https://docs.microsoft.com/azure/azure-functions/functions-monitoring> |
| Azure Event Grid とは                           | <https://docs.microsoft.com/azure/event-grid/overview> |
| Azure Functions における Azure Event Grid のバインド       | <https://docs.microsoft.com/azure/azure-functions/functions-bindings-event-grid> |
| Azure Functions を使用してコードを作成し、Azure Logic Apps のワークフローから呼び出す               | <https://docs.microsoft.com/azure/logic-apps/logic-apps-azure-functions> |
| Azure Cosmos DB と Azure Functions を使用したサーバーレス データベース コンピューティング                   | <https://docs.microsoft.com/azure/cosmos-db/serverless-computing-database> |
| Azure Functions の継続的なデプロイ          | <https://docs.microsoft.com/azure/azure-functions/functions-continuous-deployment> |
| Azure Functions をローカルでコーディングしてテストする             | <https://docs.microsoft.com/azure/azure-functions/functions-develop-local> |
| Azure Key Vault について                              | <https://docs.microsoft.com/azure/key-vault/key-vault-overview> |
| App Service と Azure Functions の Key Vault 参照を使用する      | <https://docs.microsoft.com/azure/app-service/app-service-key-vault-references> |
| Computer Vision とは                      | <https://docs.microsoft.com/azure/cognitive-services/computer-vision/overview> |
